# æ¤ç‰©æ•°å­—å­ªç”Ÿå¹³å° - æ•°æ®åº“è®¾è®¡

## 1. æ•°æ®åº“é€‰å‹

### 1.1 æ¨èæ–¹æ¡ˆ
- **å¼€å‘/å•ç”¨æˆ·ç¯å¢ƒ**ï¼šSQLite
- **ç”Ÿäº§/å¤šç”¨æˆ·ç¯å¢ƒ**ï¼šPostgreSQL

### 1.2 è®¾è®¡åŸåˆ™
- éµå¾ªæ•°æ®åº“ä¸‰èŒƒå¼
- åˆç†ä½¿ç”¨ç´¢å¼•ä¼˜åŒ–æŸ¥è¯¢
- ä¿ç•™æ•°æ®å®Œæ•´æ€§çº¦æŸ
- é¢„ç•™æ‰©å±•å­—æ®µ

---

## 2. ERå›¾ï¼ˆå®ä½“å…³ç³»å›¾ï¼‰

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚    User      â”‚         â”‚    Room      â”‚         â”‚ PlantShelf   â”‚
â”‚  (ç”¨æˆ·è¡¨)     â”‚         â”‚  (æˆ¿é—´è¡¨)     â”‚         â”‚  (èŠ±æ¶è¡¨)     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤         â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤         â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ id           â”‚         â”‚ id           â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”‚ id           â”‚
â”‚ username     â”‚         â”‚ name         â”‚         â”‚ room_id      â”‚
â”‚ email        â”‚         â”‚ description  â”‚         â”‚ name         â”‚
â”‚ password     â”‚         â”‚ location     â”‚         â”‚ description  â”‚
â”‚ created_at   â”‚         â”‚ user_id      â”‚         â”‚ sort_order   â”‚
â”‚ updated_at   â”‚         â”‚ created_at   â”‚         â”‚ capacity     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚ updated_at   â”‚         â”‚ is_default   â”‚
                         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
                                                                â”‚
                                                                â†“
                         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                 â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                         â”‚   Plant      â”‚                 â”‚   Plant      â”‚
                         â”‚  (æ¤ç‰©è¡¨)     â”‚                 â”‚  (æ¤ç‰©è¡¨)     â”‚
                         â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                 â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
                         â”‚ id           â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚ id           â”‚
                         â”‚ room_id      â”‚                 â”‚ name         â”‚
                         â”‚ shelf_id     â”‚                 â”‚ species      â”‚
                         â”‚ shelf_order  â”‚                 â”‚ description  â”‚
                         â”‚ name         â”‚                 â”‚ image_url    â”‚
                         â”‚ description  â”‚                 â”‚ purchase_dateâ”‚
                         â”‚ purchase_dateâ”‚                 â”‚ health_statusâ”‚
                         â”‚ health_statusâ”‚                 â”‚ created_at   â”‚
                         â”‚ created_at   â”‚                 â”‚ updated_at   â”‚
                         â”‚ updated_at   â”‚                 â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                         â”‚
                                                                  â”‚
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚                                               â”‚                â”‚
                    â†“                                               â†“                â†“
          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                               â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
          â”‚PlantConfig   â”‚                               â”‚CareLog       â”‚  â”‚PlantImage    â”‚
          â”‚(å…»æŠ¤é…ç½®è¡¨)   â”‚                               â”‚(å…»æŠ¤è®°å½•è¡¨)   â”‚  â”‚(æ¤ç‰©å›¾ç‰‡è¡¨)   â”‚
          â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                               â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
          â”‚ id           â”‚                               â”‚ id           â”‚  â”‚ id           â”‚
          â”‚ plant_id     â”‚                               â”‚ plant_id     â”‚  â”‚ plant_id     â”‚
          â”‚ task_type    â”‚                               â”‚ task_type    â”‚  â”‚ url          â”‚
          â”‚ interval_daysâ”‚                               â”‚ executed_at  â”‚  â”‚ caption      â”‚
          â”‚ last_done_at â”‚                               â”‚ note         â”‚  â”‚ is_primary   â”‚
          â”‚ next_due_at  â”‚                               â”‚ images       â”‚  â”‚ order        â”‚
          â”‚ is_active    â”‚                               â”‚ created_at   â”‚  â”‚ created_at   â”‚
          â”‚ season       â”‚                               â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â”‚ created_at   â”‚
          â”‚ updated_at   â”‚
          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  TaskType    â”‚
â”‚ (ä»»åŠ¡ç±»å‹è¡¨)  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ id           â”‚
â”‚ name         â”‚
â”‚ icon         â”‚
â”‚ description  â”‚
â”‚ default_days â”‚
â”‚ is_system    â”‚
â”‚ sort_order   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 3. æ•°æ®è¡¨è®¾è®¡

### 3.1 ç”¨æˆ·è¡¨ (users)
**ç”¨é€”**ï¼šå­˜å‚¨ç”¨æˆ·è´¦å·ä¿¡æ¯ï¼ˆå¦‚æœ‰å¤šç”¨æˆ·åŠŸèƒ½ï¼‰

| å­—æ®µå | ç±»å‹ | é•¿åº¦ | å…è®¸NULL | é»˜è®¤å€¼ | è¯´æ˜ |
|--------|------|------|----------|--------|------|
| id | INTEGER | - | NO | - | ä¸»é”®ï¼Œè‡ªå¢ |
| username | VARCHAR | 50 | NO | - | ç”¨æˆ·åï¼Œå”¯ä¸€ |
| email | VARCHAR | 100 | NO | - | é‚®ç®±ï¼Œå”¯ä¸€ |
| password_hash | VARCHAR | 255 | NO | - | å¯†ç å“ˆå¸Œ |
| avatar_url | VARCHAR | 500 | YES | NULL | å¤´åƒURL |
| created_at | TIMESTAMP | - | NO | CURRENT_TIMESTAMP | åˆ›å»ºæ—¶é—´ |
| updated_at | TIMESTAMP | - | NO | CURRENT_TIMESTAMP | æ›´æ–°æ—¶é—´ |

**ç´¢å¼•**ï¼š
- PRIMARY KEY (id)
- UNIQUE INDEX idx_username (username)
- UNIQUE INDEX idx_email (email)

**çº¦æŸ**ï¼š
- username: é•¿åº¦3-50å­—ç¬¦ï¼Œå­—æ¯æ•°å­—ä¸‹åˆ’çº¿
- email: æœ‰æ•ˆé‚®ç®±æ ¼å¼

---

### 3.2 æˆ¿é—´è¡¨ (rooms)
**ç”¨é€”**ï¼šå­˜å‚¨æˆ¿é—´/ä½ç½®ä¿¡æ¯

| å­—æ®µå | ç±»å‹ | é•¿åº¦ | å…è®¸NULL | é»˜è®¤å€¼ | è¯´æ˜ |
|--------|------|------|----------|--------|------|
| id | INTEGER | - | NO | - | ä¸»é”®ï¼Œè‡ªå¢ |
| user_id | INTEGER | - | YES | NULL | ç”¨æˆ·IDï¼ˆå¤–é”®ï¼‰ |
| name | VARCHAR | 50 | NO | - | æˆ¿é—´åç§° |
| description | TEXT | - | YES | NULL | æˆ¿é—´æè¿° |
| location_type | VARCHAR | 20 | NO | 'indoor' | ä½ç½®ç±»å‹ï¼šindoor/outdoor/balcony |
| icon | VARCHAR | 50 | YES | NULL | å›¾æ ‡åç§° |
| color | VARCHAR | 7 | YES | NULL | é¢œè‰²ä»£ç ï¼ˆ#FFFFFFï¼‰ |
| sort_order | INTEGER | - | NO | 0 | æ’åºé¡ºåº |
| created_at | TIMESTAMP | - | NO | CURRENT_TIMESTAMP | åˆ›å»ºæ—¶é—´ |
| updated_at | TIMESTAMP | - | NO | CURRENT_TIMESTAMP | æ›´æ–°æ—¶é—´ |

**ç´¢å¼•**ï¼š
- PRIMARY KEY (id)
- INDEX idx_user_id (user_id)
- INDEX idx_sort_order (sort_order)

**çº¦æŸ**ï¼š
- FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE
- name: éç©ºä¸”å”¯ä¸€ï¼ˆåŒä¸€ç”¨æˆ·ä¸‹ï¼‰
- location_type: 'indoor', 'outdoor', 'balcony', 'garden'

---

### 3.3 ä»»åŠ¡ç±»å‹è¡¨ (task_types)
**ç”¨é€”**ï¼šå®šä¹‰å…»æŠ¤ä»»åŠ¡ç±»å‹

| å­—æ®µå | ç±»å‹ | é•¿åº¦ | å…è®¸NULL | é»˜è®¤å€¼ | è¯´æ˜ |
|--------|------|------|----------|--------|------|
| id | INTEGER | - | NO | - | ä¸»é”®ï¼Œè‡ªå¢ |
| name | VARCHAR | 50 | NO | - | ä»»åŠ¡åç§° |
| code | VARCHAR | 20 | NO | - | ä»»åŠ¡ä»£ç ï¼ˆå”¯ä¸€ï¼‰ |
| icon | VARCHAR | 50 | YES | NULL | å›¾æ ‡ï¼ˆemojiæˆ–iconåï¼‰ |
| description | TEXT | - | YES | NULL | æè¿° |
| default_interval | INTEGER | - | NO | 7 | é»˜è®¤é—´éš”å¤©æ•° |
| is_system | BOOLEAN | - | NO | true | æ˜¯å¦ç³»ç»Ÿé¢„è®¾ |
| sort_order | INTEGER | - | NO | 0 | æ’åºé¡ºåº |
| created_at | TIMESTAMP | - | NO | CURRENT_TIMESTAMP | åˆ›å»ºæ—¶é—´ |
| updated_at | TIMESTAMP | - | NO | CURRENT_TIMESTAMP | æ›´æ–°æ—¶é—´ |

**ç´¢å¼•**ï¼š
- PRIMARY KEY (id)
- UNIQUE INDEX idx_code (code)

**åˆå§‹æ•°æ®**ï¼š
```sql
INSERT INTO task_types (name, code, icon, default_interval, is_system, sort_order) VALUES
('æµ‡æ°´', 'watering', 'ğŸ’§', 7, true, 1),
('æ–½è‚¥', 'fertilizing', 'ğŸŒ±', 30, true, 2),
('ä¿®å‰ª', 'pruning', 'âœ‚ï¸', 60, true, 3),
('æ¢ç›†', 'repotting', 'ğŸª´', 365, true, 4),
('å–·é›¾', 'spraying', 'ğŸŒ¿', 3, true, 5),
('æ¾åœŸ', 'loosening', 'ğŸ”¨', 30, true, 6);
```

---

### 3.4 æ¤ç‰©è¡¨ (plants)
**ç”¨é€”**ï¼šå­˜å‚¨æ¤ç‰©åŸºæœ¬ä¿¡æ¯

| å­—æ®µå | ç±»å‹ | é•¿åº¦ | å…è®¸NULL | é»˜è®¤å€¼ | è¯´æ˜ |
|--------|------|------|----------|--------|------|
| id | INTEGER | - | NO | - | ä¸»é”®ï¼Œè‡ªå¢ |
| user_id | INTEGER | - | YES | NULL | ç”¨æˆ·IDï¼ˆå¤–é”®ï¼‰ |
| room_id | INTEGER | - | NO | - | æ‰€å±æˆ¿é—´ID |
| shelf_id | INTEGER | - | YES | NULL | æ‰€å±èŠ±æ¶IDï¼ˆå¤–é”®ï¼‰ |
| shelf_order | INTEGER | - | NO | 0 | åœ¨èŠ±æ¶ä¸­çš„é¡ºåº |
| name | VARCHAR | 100 | NO | - | æ¤ç‰©åç§° |
| scientific_name | VARCHAR | 100 | YES | NULL | å­¦å/å“ç§ |
| description | TEXT | - | YES | NULL | æ¤ç‰©ç®€ä»‹ |
| purchase_date | DATE | - | YES | NULL | è´­ä¹°/è·å¾—æ—¥æœŸ |
| health_status | VARCHAR | 20 | NO | 'healthy' | å¥åº·çŠ¶æ€ï¼šhealthy/good/poor/critical |
| primary_image_id | INTEGER | - | YES | NULL | ä¸»å›¾ç‰‡IDï¼ˆå¤–é”®ï¼‰ |
| is_active | BOOLEAN | - | NO | true | æ˜¯å¦æ¿€æ´» |
| created_at | TIMESTAMP | - | NO | CURRENT_TIMESTAMP | åˆ›å»ºæ—¶é—´ |
| updated_at | TIMESTAMP | - | NO | CURRENT_TIMESTAMP | æ›´æ–°æ—¶é—´ |

**ç´¢å¼•**ï¼š
- PRIMARY KEY (id)
- INDEX idx_user_id (user_id)
- INDEX idx_room_id (room_id)
- INDEX idx_shelf_id (shelf_id)
- INDEX idx_health_status (health_status)
- INDEX idx_is_active (is_active)

**çº¦æŸ**ï¼š
- FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE
- FOREIGN KEY (room_id) REFERENCES rooms(id) ON DELETE SET NULL
- FOREIGN KEY (shelf_id) REFERENCES plant_shelves(id) ON DELETE SET NULL
- FOREIGN KEY (primary_image_id) REFERENCES plant_images(id) ON DELETE SET NULL
- health_status: 'healthy', 'good', 'fair', 'poor', 'critical'

---

### 3.5 æ¤ç‰©èŠ±æ¶è¡¨ (plant_shelves)
**ç”¨é€”**ï¼šå­˜å‚¨æˆ¿é—´å†…çš„èŠ±æ¶ä¿¡æ¯ï¼Œå®ç°ä¸‰å±‚æ¶æ„ï¼ˆæˆ¿é—´â†’èŠ±æ¶â†’æ¤ç‰©ï¼‰

| å­—æ®µå | ç±»å‹ | é•¿åº¦ | å…è®¸NULL | é»˜è®¤å€¼ | è¯´æ˜ |
|--------|------|------|----------|--------|------|
| id | INTEGER | - | NO | - | ä¸»é”®ï¼Œè‡ªå¢ |
| room_id | INTEGER | - | NO | - | æ‰€å±æˆ¿é—´IDï¼ˆå¤–é”®ï¼‰ |
| name | VARCHAR | 100 | NO | - | èŠ±æ¶åç§° |
| description | TEXT | - | YES | NULL | èŠ±æ¶æè¿° |
| sort_order | INTEGER | - | NO | 0 | æ’åºé¡ºåº |
| capacity | INTEGER | - | NO | 10 | èŠ±æ¶å®¹é‡ï¼ˆæœ€å¤šæ”¾å¤šå°‘æ ªæ¤ç‰©ï¼‰ |
| is_active | BOOLEAN | - | NO | true | æ˜¯å¦æ¿€æ´» |
| is_default | BOOLEAN | - | NO | false | æ˜¯å¦ä¸ºé»˜è®¤èŠ±æ¶ |
| created_at | TIMESTAMP | - | NO | CURRENT_TIMESTAMP | åˆ›å»ºæ—¶é—´ |
| updated_at | TIMESTAMP | - | NO | CURRENT_TIMESTAMP | æ›´æ–°æ—¶é—´ |

**ç´¢å¼•**ï¼š
- PRIMARY KEY (id)
- INDEX idx_room_id (room_id)
- INDEX idx_sort_order (sort_order)
- INDEX idx_is_default (is_default)

**çº¦æŸ**ï¼š
- FOREIGN KEY (room_id) REFERENCES rooms(id) ON DELETE CASCADE
- æ¯ä¸ªæˆ¿é—´åº”è¯¥æœ‰ä¸€ä¸ªé»˜è®¤èŠ±æ¶ï¼ˆis_default=trueï¼‰
- é»˜è®¤èŠ±æ¶ä¸èƒ½è¢«åˆ é™¤
- åˆ é™¤èŠ±æ¶æ—¶ï¼Œå…³è”æ¤ç‰©çš„ shelf_id è®¾ä¸º NULL

**è¯´æ˜**ï¼š
- æ¯ä¸ªæˆ¿é—´å¯ä»¥æœ‰å¤šä¸ªèŠ±æ¶
- æ¯ä¸ªæˆ¿é—´åº”è¯¥æœ‰ä¸€ä¸ªé»˜è®¤èŠ±æ¶ï¼Œæ–°åˆ›å»ºçš„æ¤ç‰©é»˜è®¤æ”¾å…¥è¯¥èŠ±æ¶
- é»˜è®¤èŠ±æ¶ä¸èƒ½å‚ä¸æ’åºï¼Œå§‹ç»ˆåœ¨ç¬¬ä¸€ä½
- æ™®é€šèŠ±æ¶å¯ä»¥è‡ªç”±æ’åº

---

### 3.6 æ¤ç‰©å›¾ç‰‡è¡¨ (plant_images)
**ç”¨é€”**ï¼šå­˜å‚¨æ¤ç‰©å›¾ç‰‡ä¿¡æ¯

| å­—æ®µå | ç±»å‹ | é•¿åº¦ | å…è®¸NULL | é»˜è®¤å€¼ | è¯´æ˜ |
|--------|------|------|----------|--------|------|
| id | INTEGER | - | NO | - | ä¸»é”®ï¼Œè‡ªå¢ |
| plant_id | INTEGER | - | NO | - | æ¤ç‰©IDï¼ˆå¤–é”®ï¼‰ |
| url | VARCHAR | 500 | NO | - | å›¾ç‰‡URL |
| thumbnail_url | VARCHAR | 500 | YES | NULL | ç¼©ç•¥å›¾URL |
| caption | VARCHAR | 200 | YES | NULL | å›¾ç‰‡è¯´æ˜ |
| is_primary | BOOLEAN | - | NO | false | æ˜¯å¦ä¸ºä¸»å›¾ |
| file_size | INTEGER | - | YES | NULL | æ–‡ä»¶å¤§å°ï¼ˆå­—èŠ‚ï¼‰ |
| width | INTEGER | - | YES | NULL | å›¾ç‰‡å®½åº¦ |
| height | INTEGER | - | YES | NULL | å›¾ç‰‡é«˜åº¦ |
| sort_order | INTEGER | - | NO | 0 | æ’åºé¡ºåº |
| created_at | TIMESTAMP | - | NO | CURRENT_TIMESTAMP | ä¸Šä¼ æ—¶é—´ |

**ç´¢å¼•**ï¼š
- PRIMARY KEY (id)
- INDEX idx_plant_id (plant_id)
- INDEX idx_is_primary (is_primary)

**çº¦æŸ**ï¼š
- FOREIGN KEY (plant_id) REFERENCES plants(id) ON DELETE CASCADE
- åŒä¸€æ¤ç‰©åªèƒ½æœ‰ä¸€å¼ ä¸»å›¾ï¼ˆåº”ç”¨å±‚ä¿è¯ï¼‰

---

### 3.7 æ¤ç‰©å…»æŠ¤é…ç½®è¡¨ (plant_configs)
**ç”¨é€”**ï¼šé…ç½®æ¯ä¸ªæ¤ç‰©çš„å…»æŠ¤ä»»åŠ¡é—´éš”

| å­—æ®µå | ç±»å‹ | é•¿åº¦ | å…è®¸NULL | é»˜è®¤å€¼ | è¯´æ˜ |
|--------|------|------|----------|--------|------|
| id | INTEGER | - | NO | - | ä¸»é”®ï¼Œè‡ªå¢ |
| plant_id | INTEGER | - | NO | - | æ¤ç‰©IDï¼ˆå¤–é”®ï¼‰ |
| task_type_id | INTEGER | - | NO | - | ä»»åŠ¡ç±»å‹IDï¼ˆå¤–é”®ï¼‰ |
| interval_days | INTEGER | - | NO | 7 | é—´éš”å¤©æ•° |
| last_done_at | TIMESTAMP | - | YES | NULL | ä¸Šæ¬¡æ‰§è¡Œæ—¶é—´ |
| next_due_at | TIMESTAMP | - | YES | NULL | ä¸‹æ¬¡åˆ°æœŸæ—¶é—´ |
| is_active | BOOLEAN | - | NO | true | æ˜¯å¦å¯ç”¨ |
| season | VARCHAR | 10 | YES | NULL | å­£èŠ‚ï¼šspring/summer/autumn/winter/all |
| notes | TEXT | - | YES | NULL | å¤‡æ³¨ |
| created_at | TIMESTAMP | - | NO | CURRENT_TIMESTAMP | åˆ›å»ºæ—¶é—´ |
| updated_at | TIMESTAMP | - | NO | CURRENT_TIMESTAMP | æ›´æ–°æ—¶é—´ |

**ç´¢å¼•**ï¼š
- PRIMARY KEY (id)
- UNIQUE INDEX idx_plant_task (plant_id, task_type_id, season)
- INDEX idx_next_due_at (next_due_at)
- INDEX idx_is_active (is_active)

**çº¦æŸ**ï¼š
- FOREIGN KEY (plant_id) REFERENCES plants(id) ON DELETE CASCADE
- FOREIGN KEY (task_type_id) REFERENCES task_types(id) ON DELETE CASCADE
- interval_days: 1-365
- season: 'spring', 'summer', 'autumn', 'winter', 'all', NULL

---

### 3.8 å…»æŠ¤è®°å½•è¡¨ (care_logs)
**ç”¨é€”**ï¼šè®°å½•æ‰€æœ‰å…»æŠ¤æ“ä½œå†å²

| å­—æ®µå | ç±»å‹ | é•¿åº¦ | å…è®¸NULL | é»˜è®¤å€¼ | è¯´æ˜ |
|--------|------|------|----------|--------|------|
| id | INTEGER | - | NO | - | ä¸»é”®ï¼Œè‡ªå¢ |
| plant_id | INTEGER | - | NO | - | æ¤ç‰©IDï¼ˆå¤–é”®ï¼‰ |
| task_type_id | INTEGER | - | NO | - | ä»»åŠ¡ç±»å‹IDï¼ˆå¤–é”®ï¼‰ |
| executed_at | TIMESTAMP | - | NO | CURRENT_TIMESTAMP | æ‰§è¡Œæ—¶é—´ |
| note | TEXT | - | YES | NULL | å¤‡æ³¨ |
| result | VARCHAR | 20 | YES | NULL | æ‰§è¡Œç»“æœï¼šsuccess/skipped/failed |
| created_at | TIMESTAMP | - | NO | CURRENT_TIMESTAMP | åˆ›å»ºæ—¶é—´ |
| updated_at | TIMESTAMP | - | NO | CURRENT_TIMESTAMP | æ›´æ–°æ—¶é—´ |

**ç´¢å¼•**ï¼š
- PRIMARY KEY (id)
- INDEX idx_plant_id (plant_id)
- INDEX idx_task_type_id (task_type_id)
- INDEX idx_executed_at (executed_at)
- INDEX idx_plant_executed (plant_id, executed_at DESC)

**çº¦æŸ**ï¼š
- FOREIGN KEY (plant_id) REFERENCES plants(id) ON DELETE CASCADE
- FOREIGN KEY (task_type_id) REFERENCES task_types(id) ON DELETE RESTRICT
- executed_at: ä¸èƒ½æ™šäºå½“å‰æ—¶é—´
- result: 'success', 'skipped', 'failed'

---

### 3.9 å…»æŠ¤è®°å½•å›¾ç‰‡è¡¨ (care_log_images)
**ç”¨é€”**ï¼šå…»æŠ¤è®°å½•çš„å…³è”å›¾ç‰‡

| å­—æ®µå | ç±»å‹ | é•¿åº¦ | å…è®¸NULL | é»˜è®¤å€¼ | è¯´æ˜ |
|--------|------|------|----------|--------|------|
| id | INTEGER | - | NO | - | ä¸»é”®ï¼Œè‡ªå¢ |
| care_log_id | INTEGER | - | NO | - | å…»æŠ¤è®°å½•IDï¼ˆå¤–é”®ï¼‰ |
| url | VARCHAR | 500 | NO | - | å›¾ç‰‡URL |
| caption | VARCHAR | 200 | YES | NULL | å›¾ç‰‡è¯´æ˜ |
| sort_order | INTEGER | - | NO | 0 | æ’åºé¡ºåº |
| created_at | TIMESTAMP | - | NO | CURRENT_TIMESTAMP | åˆ›å»ºæ—¶é—´ |

**ç´¢å¼•**ï¼š
- PRIMARY KEY (id)
- INDEX idx_care_log_id (care_log_id)

**çº¦æŸ**ï¼š
- FOREIGN KEY (care_log_id) REFERENCES care_logs(id) ON DELETE CASCADE

---

## 4. æ•°æ®åº“å…³ç³»è¯´æ˜

### 4.1 ä¸»è¦å…³ç³»
1. **User 1:N Room** - ä¸€ä¸ªç”¨æˆ·å¯ä»¥æœ‰å¤šä¸ªæˆ¿é—´
2. **User 1:N Plant** - ä¸€ä¸ªç”¨æˆ·å¯ä»¥æœ‰å¤šä¸ªæ¤ç‰©
3. **Room 1:N PlantShelf** - ä¸€ä¸ªæˆ¿é—´å¯ä»¥æœ‰å¤šä¸ªèŠ±æ¶
4. **PlantShelf 1:N Plant** - ä¸€ä¸ªèŠ±æ¶å¯ä»¥æœ‰å¤šæ ªæ¤ç‰©
5. **Room 1:N Plant** - ä¸€ä¸ªæˆ¿é—´å¯ä»¥æœ‰å¤šæ ªæ¤ç‰©ï¼ˆé€šè¿‡èŠ±æ¶é—´æ¥å…³è”ï¼‰
6. **Plant 1:N PlantImage** - ä¸€æ ªæ¤ç‰©å¯ä»¥æœ‰å¤šå¼ å›¾ç‰‡
7. **Plant 1:N PlantConfig** - ä¸€æ ªæ¤ç‰©å¯ä»¥æœ‰å¤šä¸ªå…»æŠ¤é…ç½®
8. **Plant 1:N CareLog** - ä¸€æ ªæ¤ç‰©å¯ä»¥æœ‰å¤šæ¡å…»æŠ¤è®°å½•
9. **TaskType 1:N PlantConfig** - ä¸€ä¸ªä»»åŠ¡ç±»å‹å¯ç”¨äºå¤šä¸ªæ¤ç‰©
10. **TaskType 1:N CareLog** - ä¸€ä¸ªä»»åŠ¡ç±»å‹å¯ä»¥æœ‰å¤šæ¡è®°å½•
11. **CareLog 1:N CareLogImage** - ä¸€æ¡è®°å½•å¯ä»¥æœ‰å¤šå¼ å›¾ç‰‡

### 4.2 çº§è”è§„åˆ™
- **CASCADE**ï¼šåˆ é™¤ç”¨æˆ·/æˆ¿é—´/èŠ±æ¶/æ¤ç‰©æ—¶ï¼Œè‡ªåŠ¨åˆ é™¤å…³è”æ•°æ®
- **SET NULL**ï¼šåˆ é™¤æˆ¿é—´æˆ–èŠ±æ¶æ—¶ï¼Œæ¤ç‰©çš„room_id/shelf_idè®¾ä¸ºNULL
- **RESTRICT**ï¼šåˆ é™¤ä»»åŠ¡ç±»å‹å‰éœ€ç¡®ä¿æ— å…³è”è®°å½•

---

## 5. Prisma Schemaå®šä¹‰

```prisma
// prisma/schema.prisma

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql" // æˆ– "sqlite"
  url      = env("DATABASE_URL")
}

// ç”¨æˆ·è¡¨ï¼ˆå¯é€‰ï¼Œå•ç”¨æˆ·ç‰ˆå¯ä¸éœ€è¦ï¼‰
model User {
  id           Int      @id @default(autoincrement())
  username     String   @unique @db.VarChar(50)
  email        String   @unique @db.VarChar(100)
  passwordHash String   @map("password_hash") @db.VarChar(255)
  avatarUrl    String?  @map("avatar_url") @db.VarChar(500)
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  rooms  Room[]
  plants Plant[]

  @@map("users")
}

// æˆ¿é—´è¡¨
model Room {
  id           Int      @id @default(autoincrement())
  userId       Int?     @map("user_id")
  name         String   @db.VarChar(50)
  description  String?  @db.Text
  locationType String   @default("indoor") @map("location_type") @db.VarChar(20)
  icon         String?  @db.VarChar(50)
  color        String?  @db.VarChar(7)
  sortOrder    Int      @default(0) @map("sort_order")
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  user   User?   @relation(fields: [userId], references: [id], onDelete: Cascade)
  plants Plant[]

  @@index([userId])
  @@index([sortOrder])
  @@map("rooms")
}

// ä»»åŠ¡ç±»å‹è¡¨
model TaskType {
  id              Int       @id @default(autoincrement())
  name            String    @db.VarChar(50)
  code            String    @unique @db.VarChar(20)
  icon            String?   @db.VarChar(50)
  description     String?   @db.Text
  defaultInterval Int       @default(7) @map("default_interval")
  isSystem        Boolean   @default(true) @map("is_system")
  sortOrder       Int       @default(0) @map("sort_order")
  createdAt       DateTime  @default(now()) @map("created_at")
  updatedAt       DateTime  @updatedAt @map("updated_at")

  plantConfigs PlantConfig[]
  careLogs     CareLog[]

  @@map("task_types")
}

// æ¤ç‰©è¡¨
model Plant {
  id             Int       @id @default(autoincrement())
  userId         Int?      @map("user_id")
  roomId         Int       @map("room_id")
  name           String    @db.VarChar(100)
  scientificName String?   @map("scientific_name") @db.VarChar(100)
  description    String?   @db.Text
  purchaseDate   DateTime? @map("purchase_date") @db.Date
  healthStatus   String    @default("healthy") @map("health_status") @db.VarChar(20)
  primaryImageId Int?      @map("primary_image_id")
  isActive       Boolean   @default(true) @map("is_active")
  createdAt      DateTime  @default(now()) @map("created_at")
  updatedAt      DateTime  @updatedAt @map("updated_at")

  user          User?          @relation(fields: [userId], references: [id], onDelete: Cascade)
  room          Room           @relation(fields: [roomId], references: [id], onDelete: SetNull)
  primaryImage  PlantImage?    @relation("PrimaryImage", fields: [primaryImageId], references: [id], onDelete: SetNull)
  images        PlantImage[]
  plantConfigs  PlantConfig[]
  careLogs      CareLog[]

  @@index([userId])
  @@index([roomId])
  @@index([healthStatus])
  @@index([isActive])
  @@map("plants")
}

// æ¤ç‰©å›¾ç‰‡è¡¨
model PlantImage {
  id            Int      @id @default(autoincrement())
  plantId       Int      @map("plant_id")
  url           String   @db.VarChar(500)
  thumbnailUrl  String?  @map("thumbnail_url") @db.VarChar(500)
  caption       String?  @db.VarChar(200)
  isPrimary     Boolean  @default(false) @map("is_primary")
  fileSize      Int?     @map("file_size")
  width         Int?
  height        Int?
  sortOrder     Int      @default(0) @map("sort_order")
  createdAt     DateTime @default(now()) @map("created_at")

  plant        Plant       @relation(fields: [plantId], references: [id], onDelete: Cascade)
  primaryFor   Plant?      @relation("PrimaryImage")

  @@index([plantId])
  @@index([isPrimary])
  @@map("plant_images")
}

// æ¤ç‰©å…»æŠ¤é…ç½®è¡¨
model PlantConfig {
  id            Int       @id @default(autoincrement())
  plantId       Int       @map("plant_id")
  taskTypeId    Int       @map("task_type_id")
  intervalDays  Int       @map("interval_days")
  lastDoneAt    DateTime? @map("last_done_at")
  nextDueAt     DateTime? @map("next_due_at")
  isActive      Boolean   @default(true) @map("is_active")
  season        String?   @db.VarChar(10)
  notes         String?   @db.Text
  createdAt     DateTime  @default(now()) @map("created_at")
  updatedAt     DateTime  @updatedAt @map("updated_at")

  plant    Plant    @relation(fields: [plantId], references: [id], onDelete: Cascade)
  taskType TaskType @relation(fields: [taskTypeId], references: [id], onDelete: Cascade)

  @@unique([plantId, taskTypeId, season], name: "idx_plant_task")
  @@index([nextDueAt])
  @@index([isActive])
  @@map("plant_configs")
}

// å…»æŠ¤è®°å½•è¡¨
model CareLog {
  id         Int       @id @default(autoincrement())
  plantId    Int       @map("plant_id")
  taskTypeId Int       @map("task_type_id")
  executedAt DateTime  @default(now()) @map("executed_at")
  note       String?   @db.Text
  result     String?   @db.VarChar(20)
  createdAt  DateTime  @default(now()) @map("created_at")
  updatedAt  DateTime  @updatedAt @map("updated_at")

  plant  Plant        @relation(fields: [plantId], references: [id], onDelete: Cascade)
  taskType TaskType   @relation(fields: [taskTypeId], references: [id], onDelete: Restrict)
  images CareLogImage[]

  @@index([plantId])
  @@index([taskTypeId])
  @@index([executedAt])
  @@index([plantId, executedAt(sort: Desc)], name: "idx_plant_executed")
  @@map("care_logs")
}

// å…»æŠ¤è®°å½•å›¾ç‰‡è¡¨
model CareLogImage {
  id        Int      @id @default(autoincrement())
  careLogId Int      @map("care_log_id")
  url       String   @db.VarChar(500)
  caption   String?  @db.VarChar(200)
  sortOrder Int      @default(0) @map("sort_order")
  createdAt DateTime @default(now()) @map("created_at")

  careLog CareLog @relation(fields: [careLogId], references: [id], onDelete: Cascade)

  @@index([careLogId])
  @@map("care_log_images")
}
```

---

## 6. æ•°æ®åº“åˆå§‹åŒ–è„šæœ¬

### 6.1 PostgreSQLåˆå§‹åŒ–

```sql
-- åˆ›å»ºæ•°æ®åº“
CREATE DATABASE plant_dtp;

-- è¿æ¥åˆ°æ•°æ®åº“
\c plant_dtp;

-- åˆ›å»ºæ‰©å±•ï¼ˆç”¨äºUUIDã€å…¨æ–‡æœç´¢ç­‰ï¼‰
CREATE EXTENSION IF NOT EXISTS "uuid-ossp";

-- æ‰§è¡ŒPrismaè¿ç§»ï¼ˆæ¨èä½¿ç”¨Prisma CLIï¼‰
-- npx prisma migrate dev --name init
```

### 6.2 SQLiteåˆå§‹åŒ–

```bash
# SQLiteä¼šè‡ªåŠ¨åˆ›å»ºæ–‡ä»¶ï¼Œæ— éœ€æ‰‹åŠ¨åˆå§‹åŒ–
# ä½¿ç”¨Prismaè‡ªåŠ¨ç”Ÿæˆè¡¨ç»“æ„
npx prisma migrate dev --name init
```

### 6.3 åˆå§‹æ•°æ®ç§å­

```typescript
// prisma/seed.ts

import { PrismaClient } from '@prisma/client';

const prisma = new PrismaClient();

async function main() {
  // åˆ›å»ºä»»åŠ¡ç±»å‹
  await prisma.taskType.createMany({
    data: [
      { name: 'æµ‡æ°´', code: 'watering', icon: 'ğŸ’§', defaultInterval: 7, isSystem: true, sortOrder: 1 },
      { name: 'æ–½è‚¥', code: 'fertilizing', icon: 'ğŸŒ±', defaultInterval: 30, isSystem: true, sortOrder: 2 },
      { name: 'ä¿®å‰ª', code: 'pruning', icon: 'âœ‚ï¸', defaultInterval: 60, isSystem: true, sortOrder: 3 },
      { name: 'æ¢ç›†', code: 'repotting', icon: 'ğŸª´', defaultInterval: 365, isSystem: true, sortOrder: 4 },
      { name: 'å–·é›¾', code: 'spraying', icon: 'ğŸŒ¿', defaultInterval: 3, isSystem: true, sortOrder: 5 },
      { name: 'æ¾åœŸ', code: 'loosening', icon: 'ğŸ”¨', defaultInterval: 30, isSystem: true, sortOrder: 6 },
    ],
    skipDuplicates: true,
  });

  console.log('ç§å­æ•°æ®åˆ›å»ºå®Œæˆï¼');
}

main()
  .catch((e) => {
    console.error(e);
    process.exit(1);
  })
  .finally(async () => {
    await prisma.$disconnect();
  });
```

---

## 7. æ•°æ®åº“ç´¢å¼•ä¼˜åŒ–

### 7.1 æŸ¥è¯¢åœºæ™¯åˆ†æ

| åœºæ™¯ | æ¶‰åŠè¡¨ | é¢‘ç‡ | ç´¢å¼•ç­–ç•¥ |
|-----|--------|------|----------|
| æŸ¥çœ‹ä»Šæ—¥ä»»åŠ¡ | plant_configs, care_logs | é«˜ | next_due_at |
| æ¤ç‰©åˆ—è¡¨ | plants | é«˜ | room_id, is_active |
| æ¤ç‰©è¯¦æƒ… | plants, plant_configs, care_logs | é«˜ | plant_id |
| å…»æŠ¤å†å² | care_logs | ä¸­ | plant_id, executed_at |
| ç»Ÿè®¡åˆ†æ | plants, care_logs | ä½ | user_id, created_at |

### 7.2 å¤åˆç´¢å¼•å»ºè®®

```sql
-- æŸ¥è¯¢å³å°†åˆ°æœŸçš„ä»»åŠ¡
CREATE INDEX idx_config_active_due ON plant_configs(is_active, next_due_at)
  WHERE is_active = true;

-- æŸ¥è¯¢æ¤ç‰©å…»æŠ¤å†å²
CREATE INDEX idx_carelog_plant_date ON care_logs(plant_id, executed_at DESC);

-- ç»Ÿè®¡ç”¨æˆ·æ•°æ®
CREATE INDEX idx_plant_user_active ON plants(user_id, is_active);
```

---

## 8. æ•°æ®è¿ç§»ç­–ç•¥

### 8.1 ç‰ˆæœ¬æ§åˆ¶
ä½¿ç”¨Prisma Migrateç®¡ç†æ‰€æœ‰æ•°æ®åº“å˜æ›´ï¼š

```bash
# åˆ›å»ºè¿ç§»
npx prisma migrate dev --name add_plant_health_score

# åº”ç”¨åˆ°ç”Ÿäº§
npx prisma migrate deploy

# å›æ»šï¼ˆéœ€è¦æ‰‹åŠ¨ï¼‰
npx prisma migrate resolve --rolled-back "add_plant_health_score"
```

### 8.2 æ•°æ®å¤‡ä»½

```bash
# PostgreSQL
pg_dump -U username -d plant_dtp > backup_$(date +%Y%m%d).sql

# æ¢å¤
psql -U username -d plant_dtp < backup_20241201.sql

# SQLiteï¼ˆç›´æ¥å¤åˆ¶æ–‡ä»¶ï¼‰
cp plant_dtp.db backup_$(date +%Y%m%d).db
```

---

## 9. æ€§èƒ½ä¼˜åŒ–å»ºè®®

### 9.1 æŸ¥è¯¢ä¼˜åŒ–
- ä½¿ç”¨åˆ†é¡µï¼ˆLIMIT + OFFSETï¼‰
- é¿å…N+1æŸ¥è¯¢ï¼ˆä½¿ç”¨JOINæˆ–INCLUDEï¼‰
- åˆç†ä½¿ç”¨ç´¢å¼•è¦†ç›–

### 9.2 å­˜å‚¨ä¼˜åŒ–
- å›¾ç‰‡ä½¿ç”¨å¯¹è±¡å­˜å‚¨ï¼ˆOSS/S3ï¼‰ï¼Œæ•°æ®åº“åªå­˜URL
- å¤§æ–‡æœ¬å­—æ®µè€ƒè™‘å‹ç¼©
- å®šæœŸæ¸…ç†æ— ç”¨æ•°æ®

### 9.3 è¿æ¥æ± é…ç½®

```typescript
// Prismaè¿æ¥æ± é…ç½®
datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
  // è¿æ¥æ± é…ç½®
  pool_timeout = 30
  connection_limit = 10
}
```

---

## 10. æ•°æ®å®Œæ•´æ€§çº¦æŸ

### 10.1 CHECKçº¦æŸï¼ˆç¤ºä¾‹ï¼‰

```sql
-- PostgreSQLç¤ºä¾‹
ALTER TABLE plants
ADD CONSTRAINT chk_health_status
CHECK (health_status IN ('healthy', 'good', 'fair', 'poor', 'critical'));

ALTER TABLE plant_configs
ADD CONSTRAINT chk_interval_days
CHECK (interval_days >= 1 AND interval_days <= 365);

ALTER TABLE plant_configs
ADD CONSTRAINT chk_season
CHECK (season IN ('spring', 'summer', 'autumn', 'winter', 'all') OR season IS NULL);
```

### 10.2 è§¦å‘å™¨ï¼ˆå¯é€‰ï¼‰

```sql
-- è‡ªåŠ¨æ›´æ–°updated_atå­—æ®µ
CREATE OR REPLACE FUNCTION update_updated_at_column()
RETURNS TRIGGER AS $$
BEGIN
  NEW.updated_at = NOW();
  RETURN NEW;
END;
$$ language 'plpgsql';

CREATE TRIGGER update_rooms_updated_at BEFORE UPDATE ON rooms
FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();
```

---

## 11. æ•°æ®å­—å…¸

| è¡¨å | ä¸­æ–‡å | è®°å½•æ•°é¢„ä¼° | å¢é•¿é€Ÿåº¦ |
|-----|--------|-----------|----------|
| users | ç”¨æˆ·è¡¨ | 1-100 | æ…¢ |
| rooms | æˆ¿é—´è¡¨ | 5-20 | æ…¢ |
| plants | æ¤ç‰©è¡¨ | 20-200 | ä¸­ |
| plant_images | æ¤ç‰©å›¾ç‰‡ | 100-1000 | ä¸­ |
| task_types | ä»»åŠ¡ç±»å‹ | 6-20 | ææ…¢ |
| plant_configs | å…»æŠ¤é…ç½® | 100-2000 | ä¸­ |
| care_logs | å…»æŠ¤è®°å½• | 1000-50000 | å¿« |
| care_log_images | è®°å½•å›¾ç‰‡ | 500-5000 | å¿« |

---

## 12. å®‰å…¨å»ºè®®

1. **SQLæ³¨å…¥é˜²æŠ¤**ï¼šä½¿ç”¨Prisma ORMè‡ªåŠ¨é˜²æŠ¤
2. **æ•æ„Ÿæ•°æ®åŠ å¯†**ï¼špassword_hashä½¿ç”¨bcrypt
3. **è®¿é—®æ§åˆ¶**ï¼šåŸºäºuser_idçš„æ•°æ®éš”ç¦»
4. **å®¡è®¡æ—¥å¿—**ï¼šè®°å½•é‡è¦æ“ä½œï¼ˆåˆ›å»º/åˆ é™¤ï¼‰
5. **å¤‡ä»½ç­–ç•¥**ï¼šæ¯æ—¥è‡ªåŠ¨å¤‡ä»½
