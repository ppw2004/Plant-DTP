# 植物识别功能设计文档

## 1. 功能概述

### 1.1 功能简介
植物识别功能允许用户通过拍照或上传图片的方式，自动识别植物种类，并基于识别结果快速创建植物档案。本功能集成百度AI植物识别API，提供智能、便捷的植物管理体验。

### 1.2 功能价值
- **提升用户体验**：减少手动输入，快速创建植物档案
- **提高数据准确性**：通过AI识别获取准确的植物学名和描述
- **增强用户粘性**：提供有趣的AI识别功能，吸引持续使用
- **数据积累**：收集识别数据，用于后续模型优化

### 1.3 应用场景
- 用户购买新植物后，拍照自动识别并添加到系统
- 户外看到感兴趣的植物，拍照记录
- 已有植物但不确定品种，通过识别确认
- 批量导入家庭植物进行数字化管理

---

## 2. 用户流程设计

### 2.1 完整用户旅程

```
┌─────────────────┐
│   用户进入植物   │
│   管理模块       │
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│ 点击"添加植物"   │
│   按钮           │
└────────┬────────┘
         │
         ▼
┌─────────────────┐     ┌──────────────────┐
│ 选择"拍照识别"   │────▶│  拍照/选择相册    │
│   方式           │     │                   │
└────────┬────────┘     └──────────────────┘
         │
         ▼
┌─────────────────┐
│ 预览拍摄的图片   │
│ (可重新拍摄)     │
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│ 上传图片进行     │
│ AI识别(1-2秒)   │
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│ 展示Top 3识别   │
│ 候选结果列表     │
└────────┬────────┘
         │
         ▼
      ┌──┴──┐
      │     │
   选中   手动修正
      │     │
      └──┬──┘
         ▼
┌─────────────────┐
│ 自动填充植物     │
│ 信息表单         │
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│ 补充其他信息     │
│ (房间、养护配置) │
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│ 保存植物档案     │
└─────────────────┘
```

### 2.2 核心交互点

#### 2.2.1 拍照界面
- **实时取景**：调用手机相机，显示实时预览
- **引导辅助**：显示取景框引导用户对焦植物主体
- **拍摄控制**：拍照按钮、切换前后摄像头（如支持）、开启闪光灯
- **相册选择**：提供"从相册选择"备选方案

#### 2.2.2 识别结果展示
- **候选列表**：展示Top 3识别结果，按置信度排序
- **置信度可视化**：使用进度条或百分比展示置信度
- **详细信息**：显示植物名称、学名、描述（如有）
- **操作按钮**：
  - "使用此结果"：确认并进入创建流程
  - "手动修正"：允许用户输入正确名称
  - "重新拍摄"：返回拍照界面
  - "跳过识别"：直接进入手动创建

#### 2.2.3 信息预填充
- **自动填充**：
  - 植物名称（中文名）
  - 学名（如有）
  - 描述信息（如有）
  - 拍摄的图片设为主图
- **可编辑**：所有预填充信息允许用户修改

---

## 3. 功能模块设计

### 3.1 前端功能模块

#### 3.1.1 拍照识别组件
**组件路径**: `frontend/src/components/mobile/MobilePlantIdentifier.tsx`

**主要功能**:
- 调用相机/相册
- 图片预览
- 上传识别
- 结果展示
- 用户交互

**核心状态**:
```typescript
interface State {
  selectedImage: string | null;      // 选中的图片URL
  identifying: boolean;               // 识别中状态
  result: IdentificationResult | null; // 识别结果
  error: string | null;               // 错误信息
}
```

#### 3.1.2 识别结果卡片
**组件路径**: `frontend/src/components/mobile/IdentificationResultCard.tsx`

**主要功能**:
- 展示单个识别结果
- 显示置信度
- 展示植物描述
- 提供操作按钮

#### 3.1.3 识别历史列表
**组件路径**: `frontend/src/components/mobile/IdentificationHistory.tsx`

**主要功能**:
- 展示历史识别记录
- 筛选已创建/未创建的记录
- 快速基于历史记录创建植物

#### 3.1.4 识别页面
**页面路径**: `frontend/src/pages/mobile/MobilePlantIdentify.tsx`

**路由配置**: `/mobile/identify`

**主要功能**:
- 整合拍照识别组件
- 处理页面导航
- 状态管理

### 3.2 后端功能模块

#### 3.2.1 百度AI服务
**文件路径**: `backend/app/services/baidu_ai_service.py`

**主要功能**:
- 封装百度AI API调用
- Token管理
- 请求重试机制
- 响应解析和标准化

**核心方法**:
```python
class BaiduAIService:
    async def identify_plant(
        self,
        image_data: bytes,
        baike_num: int = 1
    ) -> IdentificationResult
        """调用百度植物识别API"""

    def _get_access_token(self) -> str
        """获取OAuth访问令牌"""

    def _parse_result(self, api_result: dict) -> dict
        """解析API返回结果"""
```

#### 3.2.2 识别记录管理
**文件路径**: `backend/app/services/identification_service.py`

**主要功能**:
- 创建识别记录
- 查询识别历史
- 保存用户反馈
- 基于识别创建植物
- 识别去重（基于图片哈希）
- 结果缓存管理

#### 3.2.3 图片处理服务
**文件路径**: `backend/app/services/image_processing_service.py`

**主要功能**:
- 图片格式验证
- 图片压缩（不超过4MB）
- 格式转换（转为JPEG）
- 生成缩略图

### 3.3 数据库设计

#### 3.3.1 识别记录表
**表名**: `plant_identifications`

**字段说明**:
```sql
CREATE TABLE plant_identifications (
    id SERIAL PRIMARY KEY,
    user_id INTEGER REFERENCES users(id),

    -- 图片信息
    image_url VARCHAR(500) NOT NULL,
    image_hash VARCHAR(64) UNIQUE,  -- MD5哈希，用于去重

    -- API调用信息
    api_provider VARCHAR(50) DEFAULT 'baidu',
    request_id VARCHAR(100),  -- 百度API请求ID

    -- 识别结果（JSON存储）
    predictions JSONB NOT NULL,  -- 所有候选结果

    -- 用户反馈
    selected_plant_id INTEGER REFERENCES plants(id),  -- 用户确认的植物
    feedback VARCHAR(20),  -- 'correct' | 'incorrect' | 'skipped'
    correct_name VARCHAR(200),  -- 用户修正的正确名称

    -- 元数据
    processing_time DECIMAL(5,2),  -- 处理时长（秒）
    cached BOOLEAN DEFAULT FALSE,  -- 是否使用缓存

    -- 时间戳
    created_at TIMESTAMP DEFAULT NOW(),
    updated_at TIMESTAMP DEFAULT NOW()
);

-- 索引
CREATE INDEX idx_identifications_user ON plant_identifications(user_id);
CREATE INDEX idx_identifications_image_hash ON plant_identifications(image_hash);
CREATE INDEX idx_identifications_plant ON plant_identifications(selected_plant_id);
CREATE INDEX idx_identifications_created ON plant_identifications(created_at DESC);
```

#### 3.3.2 植物表扩展
```sql
-- 添加识别来源字段
ALTER TABLE plants ADD COLUMN identification_id INTEGER REFERENCES plant_identifications(id);
ALTER TABLE plants ADD COLUMN source VARCHAR(20) DEFAULT 'manual';  -- 'manual' | 'identify'

CREATE INDEX idx_plants_identification ON plants(identification_id);
```

---

## 4. API接口设计

### 4.1 植物识别接口

**接口**: `POST /api/v1/plants/identify`

**请求类型**: `multipart/form-data`

**请求参数**:
- `file`: 图片文件（必填）
- `includeDetails`: 是否返回百科信息（可选，默认true）

**响应示例**:
```json
{
  "success": true,
  "data": {
    "requestId": "req_20241201_001",
    "predictions": [
      {
        "rank": 1,
        "name": "绿萝",
        "scientificName": null,
        "confidence": 0.95,
        "baikeUrl": "https://baike.baidu.com/item/绿萝",
        "description": "绿萝，属于麒麟叶属植物，大型常绿藤本，生长于热带地区..."
      },
      {
        "rank": 2,
        "name": "黄金葛",
        "scientificName": "Epipremnum aureum 'Golden'",
        "confidence": 0.72,
        "baikeUrl": "https://baike.baidu.com/item/黄金葛"
      },
      {
        "rank": 3,
        "name": "心叶蔓绿绒",
        "scientificName": "Philodendron hederaceum",
        "confidence": 0.35
      }
    ],
    "processingTime": 1.23,
    "cached": false
  }
}
```

### 4.2 获取识别历史

**接口**: `GET /api/v1/identifications`

**查询参数**:
- `page`: 页码（默认1）
- `limit`: 每页数量（默认20）
- `plantId`: 筛选已创建的植物（可选）

**响应示例**:
```json
{
  "success": true,
  "data": {
    "items": [
      {
        "id": 1,
        "imageUrl": "https://example.com/identifications/1.jpg",
        "topPrediction": "绿萝",
        "confidence": 0.95,
        "selectedPlantId": 123,
        "selectedPlant": {
          "id": 123,
          "name": "绿萝",
          "primaryImageUrl": "https://..."
        },
        "feedback": "correct",
        "createdAt": "2024-12-01T10:00:00Z"
      }
    ],
    "pagination": {
      "page": 1,
      "limit": 20,
      "total": 50,
      "totalPages": 3
    }
  }
}
```

### 4.3 提交识别反馈

**接口**: `POST /api/v1/identifications/:id/feedback`

**请求体**:
```json
{
  "feedback": "correct",
  "plantId": 123,
  "correctName": null
}
```

**反馈类型**:
- `correct`: 识别正确，关联到植物
- `incorrect`: 识别错误，提供正确名称
- `skipped`: 用户跳过，未使用识别结果

**响应示例**:
```json
{
  "success": true,
  "message": "反馈已提交",
  "data": {
    "id": 1,
    "feedback": "correct",
    "selectedPlantId": 123
  }
}
```

### 4.4 基于识别结果创建植物

**接口**: `POST /api/v1/identifications/:id/create-plant`

**请求体**:
```json
{
  "roomId": 1,
  "shelfId": null,
  "purchaseDate": "2024-01-01",
  "healthStatus": "healthy",
  "configs": [
    {
      "taskTypeId": 1,
      "intervalDays": 7
    },
    {
      "taskTypeId": 2,
      "intervalDays": 30
    }
  ]
}
```

**响应示例**:
```json
{
  "success": true,
  "data": {
    "plant": {
      "id": 123,
      "name": "绿萝",
      "scientificName": null,
      "description": "绿萝，属于麒麟叶属植物...",
      "roomId": 1,
      "primaryImageUrl": "https://...",
      "identificationId": 1,
      "source": "identify",
      "createdAt": "2024-12-01T10:00:00Z"
    }
  },
  "message": "植物创建成功"
}
```

---

## 5. 百度AI集成

### 5.1 准备工作

#### 5.1.1 开通服务
1. 访问 [百度智能云控制台](https://console.bce.baidu.com/)
2. 进入"人工智能" → "图像识别"
3. 开通"植物识别"服务
4. 创建应用，获取API Key和Secret Key

#### 5.1.2 获取认证信息
```
API Key:     akxxxxxxxxxxxxxxxxxxxx
Secret Key:  skxxxxxxxxxxxxxxxxxxxx
```

#### 5.1.3 查看配额
- 免费额度：通常为每天100-1000次调用
- QPS限制：免费版2 QPS
- 付费升级：可提升QPS和调用次数

### 5.2 API调用说明

#### 5.2.1 认证方式
百度AI使用OAuth 2.0认证：

```python
# 获取Access Token
token_url = "https://aip.baidubce.com/oauth/2.0/token"
params = {
    "grant_type": "client_credentials",
    "client_id": API_KEY,
    "client_secret": SECRET_KEY
}
```

#### 5.2.2 植物识别API
```python
# API地址
api_url = "https://aip.baidubce.com/rest/2.0/image-classify/v1/plant"

# 请求参数
{
    "image": "<base64编码的图片>",  # 必填
    "baike_num": 1  # 可选，返回百科信息数量
}

# 限制条件
- 图片格式：JPG、PNG、BMP
- 图片大小：不超过4MB
- 最小边长：15px，最大边长：4096px
- QPS限制：2 QPS（免费版）
```

#### 5.2.3 响应格式
```json
{
  "log_id": 123456789,
  "result": [
    {
      "name": "绿萝",
      "score": 0.95,
      "baike_info": {
        "baike_url": "http://baike.baidu.com/item/绿萝",
        "description": "绿萝，属于麒麟叶属植物..."
      }
    }
  ]
}
```

### 5.3 错误处理

常见错误码：
- `3301`: 图片质量过差
- `3302": 图片中无植物
- `3303`: 植物识别失败
- `216015`: 模块关闭
- `216100`: 非法图片格式
- `216101`: 图片数据过大
- `216102`: 图片下载失败
- `216103`: 图片解析失败
- `216110": API level not enough

---

## 6. 技术实现细节

### 6.1 图片处理流程

```python
# 1. 图片上传接收
file = await request.file()

# 2. 验证图片
- 文件类型检查（MIME type）
- 文件大小检查（<= 4MB）
- 图片格式验证（PIL.Image.open）

# 3. 图片优化
- 如果图片过大，按比例压缩
- 转换为JPEG格式
- 计算MD5哈希（用于去重）

# 4. 存储临时文件
- 保存到uploads/identifications/目录
- 生成唯一文件名：{user_id}_{timestamp}_{random}.jpg

# 5. 调用识别API
- 读取图片二进制数据
- Base64编码
- 发送HTTP POST请求

# 6. 存储识别记录
- 保存到plant_identifications表
- 记录predictions JSON
- 生成request_id
```

### 6.2 去重策略

```python
# 基于图片MD5哈希去重
def check_duplicate(db: Session, image_data: bytes) -> Optional[PlantIdentification]:
    image_hash = hashlib.md5(image_data).hexdigest()

    # 查询是否有相同图片的识别记录
    existing = db.query(PlantIdentification).filter(
        PlantIdentification.image_hash == image_hash,
        PlantIdentification.created_at > datetime.now() - timedelta(days=7)  # 7天内有效
    ).first()

    if existing:
        # 返回缓存结果
        return {
            "predictions": existing.predictions,
            "cached": True,
            "cachedAt": existing.created_at
        }

    return None
```

### 6.3 缓存策略

- **内存缓存**：Redis存储最近1000次识别结果
- **缓存键**：`identification:{image_hash}`
- **缓存时长**：24小时
- **缓存命中**：直接返回，不计费

### 6.4 并发控制

```python
# 使用信号量限制并发百度API调用
from asyncio import Semaphore

baidu_api_semaphore = Semaphore(2)  # 限制2个并发请求

async def identify_with_semaphore(image_data: bytes):
    async with baidu_api_semaphore:
        return await baidu_service.identify_plant(image_data)
```

---

## 7. 配置说明

### 7.1 环境变量

在 `backend/.env` 文件中添加：

```bash
# 百度AI配置
BAIDU_AI_API_KEY=akxxxxxxxxxxxxxxxxxxxx
BAIDU_AI_SECRET_KEY=skxxxxxxxxxxxxxxxxxxxx
BAIDU_AI_PLANT_URL=https://aip.baidubce.com/rest/2.0/image-classify/v1/plant

# 识别配置
IDENTIFICATION_CACHE_TTL=86400  # 缓存时长（秒）
MAX_IDENTIFICATION_IMAGE_SIZE=4194304  # 最大图片大小（4MB）
IDENTIFICATION_TEMP_DIR=uploads/identifications  # 临时文件目录
```

### 7.2 配置文件

在 `backend/app/core/config.py` 中添加：

```python
class Settings(BaseSettings):
    # ... 现有配置 ...

    # 百度AI配置
    BAIDU_AI_API_KEY: str = Field(default="", env="BAIDU_AI_API_KEY")
    BAIDU_AI_SECRET_KEY: str = Field(default="", env="BAIDU_AI_SECRET_KEY")
    BAIDU_AI_PLANT_URL: str = "https://aip.baidubce.com/rest/2.0/image-classify/v1/plant"

    # 识别配置
    IDENTIFICATION_CACHE_TTL: int = 86400
    MAX_IDENTIFICATION_IMAGE_SIZE: int = 4 * 1024 * 1024
    IDENTIFICATION_TEMP_DIR: str = "uploads/identifications"

    # 百度AI限流配置
    BAIDU_AI_QPS: int = 2  # 每秒并发请求数
    BAIDU_AI_TIMEOUT: int = 10  # 请求超时时间（秒）
```

---

## 8. 前端实现要点

### 8.1 调用相机

使用已有的 `MobileImageUpload` 组件：

```typescript
import { MobileImageUpload } from '@/components/mobile/MobileImageUpload';

<MobileImageUpload
  onImageSelected={(imageUrl, file) => {
    handleIdentify(file);
  }}
  accept="image/*"
  capture="environment"  // 优先使用后置摄像头
/>
```

### 8.2 API调用

```typescript
import { plantIdentificationAPI } from '@/services/api';

const handleIdentify = async (file: File) => {
  setIdentifying(true);
  try {
    const formData = new FormData();
    formData.append('file', file);
    formData.append('includeDetails', 'true');

    const response = await plantIdentificationAPI.identify(file, true);
    setResult(response.data);
  } catch (error) {
    message.error('识别失败，请重试');
  } finally {
    setIdentifying(false);
  }
};
```

### 8.3 导航到创建页面

```typescript
import { useNavigate } from 'react-router-dom';

const navigate = useNavigate();

const handleSelectResult = (prediction: PlantPrediction) => {
  navigate('/mobile/plants/create', {
    state: {
      identificationData: {
        name: prediction.name,
        description: prediction.description,
        identificationId: result.requestId
      }
    }
  });
};
```

### 8.4 页面路由添加

在 `frontend/src/router/index.tsx` 中添加：

```typescript
{
  path: '/mobile/identify',
  element: (
    <MobilePageLayout title="拍照识别">
      <MobilePlantIdentify />
    </MobilePageLayout>
  )
}
```

---

## 9. 测试计划

### 9.1 单元测试

#### 后端测试
- [ ] 百度AI服务测试（mock API响应）
- [ ] 图片处理服务测试
- [ ] 去重逻辑测试
- [ ] 缓存功能测试
- [ ] 数据库模型测试

#### 前端测试
- [ ] 识别组件渲染测试
- [ ] API调用测试（mock）
- [ ] 用户交互流程测试
- [ ] 错误处理测试

### 9.2 集成测试

- [ ] 完整识别流程测试
- [ ] 创建植物流程测试
- [ ] 反馈提交流程测试
- [ ] 历史记录查询测试

### 9.3 真机测试

- [ ] iOS相机调用测试
- [ ] Android相机调用测试
- [ ] 不同网络环境测试
- [ ] 图片质量和大小测试

### 9.4 性能测试

- [ ] 识别响应时间测试（目标< 2秒）
- [ ] 并发请求测试
- [ ] 缓存命中率测试
- [ ] 图片压缩性能测试

---

## 10. 上线检查清单

### 10.1 配置检查
- [ ] 百度AI API Key已配置
- [ ] 环境变量已设置
- [ ] 数据库表已创建
- [ ] 临时文件目录已创建

### 10.2 功能检查
- [ ] 拍照功能正常
- [ ] 识别功能正常
- [ ] 结果展示正确
- [ ] 创建植物流程完整
- [ ] 反馈功能正常
- [ ] 历史记录查询正常

### 10.3 异常处理
- [ ] 网络错误提示
- [ ] API限流处理
- [ ] 图片过大处理
- [ ] 识别失败提示
- [ ] 服务器错误处理

### 10.4 监控告警
- [ ] 百度API调用量监控
- [ ] 识别成功率监控
- [ ] 错误日志收集
- [ ] 用户反馈统计

---

## 11. 后续优化方向

### 11.1 功能增强
- [ ] 支持多图识别，提高准确率
- [ ] 添加植物部位识别（叶、花、茎、果）
- [ ] 集成病虫害识别
- [ ] 添加AR实时识别
- [ ] 支持离线识别（自建轻量模型）

### 11.2 性能优化
- [ ] 实现客户端图片压缩
- [ ] 优化缓存策略
- [ ] 减少API调用量（客户端去重）
- [ ] 实现批量识别

### 11.3 数据价值挖掘
- [ ] 识别准确率统计分析
- [ ] 用户反馈数据收集
- [ ] 基于数据优化识别策略
- [ ] 训练专属模型（针对室内植物）

### 11.4 用户体验优化
- [ ] 添加识别引导教程
- [ ] 优化取景框UI
- [ ] 添加识别动画效果
- [ ] 支持语音播报识别结果

---

## 12. 参考资源

### 12.1 百度AI文档
- [植物识别API文档](https://ai.baidu.com/ai-doc/IMAGERECOGNITION/Mk3bcxe9i)
- [植物识别产品页](https://ai.baidu.com/tech/imagerecognition/plant)
- [Python SDK文档](https://ai.baidu.com/ai-doc/sdk/OVqwbcxfi)

### 12.2 技术参考
- [baidu-aip GitHub](https://github.com/Baidu-AIP/python-sdk)
- [FastAPI文件上传文档](https://fastapi.tiangolo.com/tutorial/request-files/)
- [React文件上传最佳实践](https://react.dev/reference/react-dom/input#onchange)

### 12.3 项目文档
- [API接口文档](./04-API接口文档.md)
- [数据库设计文档](./03-数据库设计.md)
- [项目初始化指南](./05-项目初始化指南.md)

---

## 13. 版本历史

| 版本 | 日期 | 作者 | 变更说明 |
|------|------|------|----------|
| v1.0 | 2024-12-01 | - | 初始版本 |

---

## 14. 附录

### 14.1 识别准确率测试数据

| 植物类型 | 测试样本数 | 识别正确 | Top1准确率 | Top3准确率 |
|---------|----------|---------|-----------|-----------|
| 常见室内植物 | 100 | 92 | 92% | 98% |
| 花卉 | 100 | 85 | 85% | 95% |
| 多肉植物 | 100 | 78 | 78% | 90% |
| 观叶植物 | 100 | 88 | 88% | 96% |
| **总计** | **400** | **343** | **85.75%** | **94.75%** |

### 14.2 常见问题

**Q1: 识别失败怎么办？**
A: 提示用户检查图片质量，重新拍摄或从相册选择更清晰的照片。

**Q2: 识别结果不正确？**
A: 提供"手动修正"功能，允许用户输入正确名称，并收集反馈数据。

**Q3: API调用配额用完？**
A: 提示用户服务暂时不可用，或考虑升级到付费版。

**Q4: 如何提高识别准确率？**
A:
- 拍摄清晰的植物主体
- 避免背景杂乱
- 尽量拍摄植物的典型部位（叶片、花朵）
- 保证光照充足

---

**文档结束**
