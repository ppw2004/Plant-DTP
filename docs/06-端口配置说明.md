# 端口配置说明

## 端口规划

本项目的所有服务均运行在 **12800+** 端口范围，避免与其他项目冲突。

### 端口分配表

| 端口 | 服务 | 环境 | 说明 |
|------|------|------|------|
| 12800 | 前端 | 生产 | Nginx托管的React静态文件 |
| 12801 | 后端API | 生产/开发 | FastAPI应用服务 |
| 12802 | 后端开发 | 开发 | FastAPI热重载服务（备用） |
| 12803 | PostgreSQL | 生产/开发 | 数据库服务（Docker） |
| 12805 | pgAdmin | 可选 | 数据库可视化管理工具 |

### 服务架构

```
┌─────────────────────────────────────────────────┐
│  用户浏览器访问                                   │
│  http://your-domain.com:12800                    │
└─────────────────────────────────────────────────┘
                    ↓
┌─────────────────────────────────────────────────┐
│  12800: Nginx (前端反向代理)                      │
│  - /        → React静态文件                      │
│  - /api     → 代理到 12801                       │
└─────────────────────────────────────────────────┘
                    ↓
┌─────────────────────────────────────────────────┐
│  12801: FastAPI (后端服务)                        │
│  - /api/*     → API接口                         │
│  - /docs      → Swagger文档                     │
│  - /redoc     → ReDoc文档                       │
└─────────────────────────────────────────────────┘
                    ↓
┌─────────────────────────────────────────────────┐
│  12803: PostgreSQL (数据库)                      │
│  数据库: plant_dtp                               │
│  用户: plantdtp                                  │
└─────────────────────────────────────────────────┘
```

## 配置文件

### 1. 后端配置

#### `backend/.env`
```env
# 服务器配置
PORT=12801
HOST=0.0.0.0

# 数据库配置
DATABASE_URL=postgresql://plantdtp:your_password@localhost:12803/plant_dtp

# CORS配置（允许前端跨域访问）
FRONTEND_URL=http://localhost:12800

# 其他配置...
```

#### `backend/main.py`
```python
import uvicorn

if __name__ == "__main__":
    uvicorn.run(
        "app:app",
        host="0.0.0.0",
        port=12801,  # 生产端口
        reload=True  # 开发环境热重载
    )
```

### 2. 前端配置

#### `frontend/.env.development`
```env
VITE_API_BASE_URL=http://localhost:12801/api
VITE_APP_PORT=12800
```

#### `frontend/.env.production`
```env
VITE_API_BASE_URL=/api  # 生产环境使用相对路径，通过Nginx代理
```

#### `frontend/vite.config.ts`
```typescript
export default defineConfig({
  server: {
    port: 5173,  // 开发端口（可以不改，或改为12802）
    proxy: {
      '/api': {
        target: 'http://localhost:12801',
        changeOrigin: true,
      }
    }
  }
})
```

### 3. Nginx配置

#### `/etc/nginx/sites-available/plant-dtp`
```nginx
# 前端服务（端口12800）
server {
    listen 12800;
    server_name your-domain.com;

    # 前端静态文件
    location / {
        root /home/user/Plant-DTP/frontend/dist;
        try_files $uri $uri/ /index.html;
    }

    # API代理到后端
    location /api {
        proxy_pass http://localhost:12801;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # API文档代理（可选）
    location /docs {
        proxy_pass http://localhost:12801;
        proxy_set_header Host $host;
    }

    # WebSocket支持（如果需要）
    location /ws {
        proxy_pass http://localhost:12801;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
    }
}
```

### 4. Docker Compose配置

#### `docker-compose.yml`
```yaml
version: '3.8'

services:
  # PostgreSQL数据库
  postgres:
    image: postgres:16-alpine
    container_name: plant-dtp-db
    environment:
      POSTGRES_USER: plantdtp
      POSTGRES_PASSWORD: your_secure_password
      POSTGRES_DB: plant_dtp
    ports:
      - "12803:5432"  # 主机端口12803映射到容器5432
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./init.sql:/docker-entrypoint-initdb.d/init.sql
    restart: unless-stopped

  # pgAdmin（可选）
  pgadmin:
    image: dpage/pgadmin4:latest
    container_name: plant-dtp-pgadmin
    environment:
      PGADMIN_DEFAULT_EMAIL: admin@example.com
      PGADMIN_DEFAULT_PASSWORD: admin
    ports:
      - "12805:80"
    depends_on:
      - postgres
    restart: unless-stopped

volumes:
  postgres_data:
```

## Systemd服务配置

### 后端服务

#### `/etc/systemd/system/plant-dtp-backend.service`
```ini
[Unit]
Description=Plant DTP FastAPI Backend
After=network.target postgresql.service

[Service]
Type=simple
User=your_username
WorkingDirectory=/home/username/Plant-DTP/backend
Environment="PATH=/home/username/Plant-DTP/backend/venv/bin"
ExecStart=/home/username/Plant-DTP/backend/venv/bin/uvicorn app:app --host 0.0.0.0 --port 12801
Restart=always
RestartSec=10

[Install]
WantedBy=multi-user.target
```

### 启动服务
```bash
# 重载systemd配置
sudo systemctl daemon-reload

# 启动后端服务
sudo systemctl start plant-dtp-backend

# 开机自启
sudo systemctl enable plant-dtp-backend

# 查看状态
sudo systemctl status plant-dtp-backend

# 查看日志
sudo journalctl -u plant-dtp-backend -f
```

## 防火墙配置

```bash
# Ubuntu/Debian
sudo ufw allow 12800/tcp
sudo ufw allow 12801/tcp
sudo ufw allow 12803/tcp  # 如果需要远程访问数据库

# CentOS/RHEL
sudo firewall-cmd --permanent --add-port=12800/tcp
sudo firewall-cmd --permanent --add-port=12801/tcp
sudo firewall-cmd --reload
```

## 开发环境启动

### 启动顺序

1. **启动数据库**
```bash
# 使用Docker
docker-compose up -d postgres

# 或使用systemd（如果本地安装PostgreSQL）
sudo systemctl start postgresql
```

2. **启动后端**
```bash
cd backend
source venv/bin/activate  # 激活虚拟环境
uvicorn app:app --host 0.0.0.0 --port 12801 --reload
```

3. **启动前端**（开发环境）
```bash
cd frontend
npm run dev  # 默认5173端口，或配置为12802
```

4. **访问应用**
   - 前端开发: http://localhost:5173
   - 后端API: http://localhost:12801
   - API文档: http://localhost:12801/docs
   - 生产前端: http://localhost:12800

## 端口占用检查

```bash
# 检查端口是否被占用
sudo lsof -i :12800
sudo lsof -i :12801
sudo lsof -i :12803

# 或使用netstat
netstat -tuln | grep 1280

# 或使用ss
ss -tuln | grep 1280
```

## 域名访问配置（可选）

如果有域名，可以配置反向代理，不使用端口：

### Nginx配置（基于域名）
```nginx
# 主域名
server {
    listen 80;
    server_name plants.yourdomain.com;

    # 前端
    location / {
        proxy_pass http://localhost:12800;
    }

    # API
    location /api {
        proxy_pass http://localhost:12801;
    }
}

# API子域名（可选）
server {
    listen 80;
    server_name api-plants.yourdomain.com;

    location / {
        proxy_pass http://localhost:12801;
    }
}
```

## 故障排查

### 问题1: 端口被占用
```bash
# 查找占用进程
sudo lsof -i :12801

# 杀死进程
sudo kill -9 <PID>

# 或更换端口（修改.env中的PORT）
```

### 问题2: 前端无法访问后端
- 检查CORS配置
- 检查防火墙规则
- 检查Nginx代理配置

### 问题3: 数据库连接失败
```bash
# 检查PostgreSQL是否运行
docker ps | grep postgres

# 检查端口
telnet localhost 12803

# 查看数据库日志
docker logs plant-dtp-db
```

## 生产环境部署检查清单

- [ ] 所有服务配置为系统服务（systemd）
- [ ] 配置开机自启
- [ ] 防火墙规则已配置
- [ ] SSL证书已配置（Let's Encrypt）
- [ ] 数据库密码已修改
- [ ] 日志轮转已配置
- [ ] 监控和告警已设置
- [ ] 备份策略已实施

## 端口快速参考

```bash
# 快速启动所有服务
docker-compose up -d postgres  # 数据库
sudo systemctl start plant-dtp-backend  # 后端
sudo systemctl start nginx  # 前端

# 快速检查所有服务状态
curl http://localhost:12801/health  # 后端健康检查
curl http://localhost:12800  # 前端访问
docker ps | grep postgres  # 数据库运行状态
```
