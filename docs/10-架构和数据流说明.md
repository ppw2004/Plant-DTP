# Plant-DTP æ¶æ„å’Œæ•°æ®æµè¯´æ˜

## ğŸ“Š å½“å‰æ¶æ„æ¦‚è§ˆ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                          è…¾è®¯äº‘æœåŠ¡å™¨                                â”‚
â”‚                         82.156.213.38                               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚    Nginx    â”‚         â”‚  SSHéš§é“     â”‚         â”‚  å‰ç«¯æ–‡ä»¶   â”‚  â”‚
â”‚  â”‚   :80      â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚   :12801     â”‚â—„â•â•â•â•â•â•â•â•â–ºâ”‚ /var/www/   â”‚  â”‚
â”‚  â”‚             â”‚         â”‚  (åå‘è½¬å‘)   â”‚         â”‚  plant-dtp/ â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                   â”‚                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                    â”‚
                            SSH éš§é“ (å†…ç½‘)
                                    â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      åç«¯æœåŠ¡å™¨ï¼ˆè¿œç¨‹/å†…ç½‘ï¼‰                          â”‚
â”‚                      (é€šè¿‡ x99 éš§é“è®¿é—®)                             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  FastAPI    â”‚         â”‚   PostgreSQL  â”‚         â”‚  å›¾ç‰‡æ–‡ä»¶   â”‚  â”‚
â”‚  â”‚  (åŠ¨æ€)     â”‚â—„â•â•â•â•â•â•â•â•â–ºâ”‚    :12803    â”‚         â”‚  /uploads/  â”‚  â”‚
â”‚  â”‚  åç«¯åº”ç”¨   â”‚         â”‚    æ•°æ®åº“    â”‚         â”‚  plants/    â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ”¼ å›¾ç‰‡ä¸Šä¼ å®Œæ•´æµç¨‹

### æ­¥éª¤è¯¦è§£

#### 1ï¸âƒ£ å®¢æˆ·ç«¯ï¼ˆç§»åŠ¨ç«¯/æµè§ˆå™¨ï¼‰
```
ç”¨æˆ·é€‰æ‹©å›¾ç‰‡
   â†“
å‰ç«¯ç»„ä»¶ï¼šImageUpload.tsx
   - ç§»åŠ¨ç«¯ï¼šæ™®é€šUploadæŒ‰é’®ï¼ˆæ”¯æŒæ‹ç…§ï¼‰
   - PCç«¯ï¼šUpload.Draggeræ‹–æ‹½åŒºåŸŸ
   â†“
FormDataåˆ›å»ºï¼š
{
  file: Fileå¯¹è±¡ (å›¾ç‰‡äºŒè¿›åˆ¶æ•°æ®),
  description: "å›¾ç‰‡æè¿°ï¼ˆå¯é€‰ï¼‰"
}
```

**å‰ç«¯ä»£ç ä½ç½®ï¼š**
- `/root/Plant-DTP/frontend/src/components/ImageUpload.tsx:64-132`
- `/root/Plant-DTP/frontend/src/services/imageService.ts:23-27`

---

#### 2ï¸âƒ£ äº‘æœåŠ¡å™¨ï¼ˆ82.156.213.38ï¼‰
```
POST /api/v1/plants/{plant_id}/images/upload
   â†“
Nginxæ¥æ”¶è¯·æ±‚ (ç«¯å£80)
   â†“
location /api/ {
    proxy_pass http://localhost:12801/api/;
    client_max_body_size 20M;      # âœ… æœ€å¤§20MB
    proxy_connect_timeout 300s;
    proxy_send_timeout 300s;
    proxy_read_timeout 300s;
}
   â†“
Nginxè½¬å‘åˆ° SSHéš§é“ç«¯å£ 12801
```

**Nginxé…ç½®ï¼š** `/etc/nginx/sites-enabled/plant-dtp:36-60`

---

#### 3ï¸âƒ£ SSHéš§é“ï¼ˆlocalhost:12801 â†’ åç«¯æœåŠ¡å™¨ï¼‰
```
SSHéš§é“è½¬å‘
   â”œâ”€ ç›‘å¬ç«¯å£: localhost:12801
   â”œâ”€ è½¬å‘ç›®æ ‡: åç«¯æœåŠ¡å™¨ï¼ˆé€šè¿‡x99å†…ç½‘éš§é“ï¼‰
   â””â”€ è¿›ç¨‹: sshd (PID: 2757907)
   â†“
è¯·æ±‚åˆ°è¾¾åç«¯æœåŠ¡å™¨ FastAPIåº”ç”¨
```

---

#### 4ï¸âƒ£ åç«¯æœåŠ¡å™¨ï¼ˆè¿œç¨‹ï¼‰
```
FastAPIæ¥æ”¶è¯·æ±‚
   â†“
è·¯ç”±: /api/v1/plants/{plant_id}/images/upload
æ–‡ä»¶: /root/Plant-DTP/backend/app/api/v1/images.py:102-186
   â†“
å¤„ç†æµç¨‹ï¼š
â”œâ”€ 1. éªŒè¯æ–‡ä»¶ç±»å‹ (ALLOWED_MIME_TYPES)
â”œâ”€ 2. éªŒè¯æ–‡ä»¶å¤§å° (MAX_FILE_SIZE: 10MB â†’ 15MB)
â”œâ”€ 3. ç”Ÿæˆå”¯ä¸€æ–‡ä»¶å (UUID + åŸæ‰©å±•å)
â”‚      ä¾‹å¦‚: 53d71a3a-b15e-4305-a31d-77f9526d3a2c.jpg
â”œâ”€ 4. ä¿å­˜æ–‡ä»¶åˆ°ç£ç›˜
â”‚      è·¯å¾„: ./uploads/plants/{filename}
â”‚      ç»å¯¹è·¯å¾„: /root/Plant-DTP/backend/uploads/plants/
â””â”€ 5. ç”Ÿæˆå›¾ç‰‡URL
       âŒ æ—§æ–¹å¼: http://localhost:12801/uploads/plants/xxx.jpg
       âœ… æ–°æ–¹å¼: ä½¿ç”¨request.urlè·å–å®¢æˆ·ç«¯è®¿é—®çš„åŸŸå
       ä¾‹å¦‚: http://82.156.213.38/uploads/plants/xxx.jpg
   â†“
ä¿å­˜åˆ°æ•°æ®åº“
   â”œâ”€ è¡¨: plant_images
   â”œâ”€ å­—æ®µ: url, caption, is_primary, plant_id
   â””â”€ è¿”å›æ–°å›¾ç‰‡è®°å½•
```

**åç«¯ä»£ç ï¼š**
- è·¯ç”±å¤„ç†: `/root/Plant-DTP/backend/app/api/v1/images.py`
- æ¨¡å‹å®šä¹‰: `/root/Plant-DTP/backend/app/models/plant_image.py`

---

#### 5ï¸âƒ£ è¿”å›å“åº”ç»™å®¢æˆ·ç«¯
```
åç«¯è¿”å› JSON:
{
  "success": true,
  "data": {
    "id": 22,
    "url": "http://82.156.213.38/uploads/plants/xxx.jpg",
    "caption": null,
    "isPrimary": false,
    ...
  }
}
   â†“
é€šè¿‡ SSHéš§é“è¿”å›
   â†“
Nginxè¿”å›ç»™å®¢æˆ·ç«¯
   â†“
å‰ç«¯åˆ·æ–°å›¾ç‰‡åˆ—è¡¨
```

---

## ğŸ”½ å›¾ç‰‡ä¸‹è½½/æ˜¾ç¤ºå®Œæ•´æµç¨‹

### æ­¥éª¤è¯¦è§£

#### 1ï¸âƒ£ å®¢æˆ·ç«¯è¯·æ±‚å›¾ç‰‡åˆ—è¡¨
```
GET /api/v1/plants/{plant_id}/images
   â†“
é€šè¿‡ Nginx â†’ SSHéš§é“ â†’ åç«¯
   â†“
åç«¯æŸ¥è¯¢æ•°æ®åº“:
   SELECT * FROM plant_images WHERE plant_id = {plant_id}
   â†“
åç«¯è°ƒç”¨ to_dict() æ–¹æ³•
   â”œâ”€ âœ… è‡ªåŠ¨è½¬æ¢ localhost URL â†’ /uploads/ç›¸å¯¹è·¯å¾„
   â””â”€ ä½ç½®: /root/Plant-DTP/backend/app/models/plant_image.py:25-45
   â†“
è¿”å›å›¾ç‰‡åˆ—è¡¨:
[
  {
    "id": 19,
    "url": "/uploads/plants/cb1c94e9-xxx.png",  // âœ… å·²ä¿®å¤
    "isPrimary": true,
    ...
  }
]
```

---

#### 2ï¸âƒ£ å®¢æˆ·ç«¯æ¸²æŸ“å›¾ç‰‡
```
å‰ç«¯ç»„ä»¶æ˜¾ç¤ºå›¾ç‰‡:
<img src="/uploads/plants/xxx.jpg" />
   â†“
æµè§ˆå™¨è§£æURL:
   ç›¸å¯¹è·¯å¾„ â†’ ç»å¯¹è·¯å¾„
   /uploads/plants/xxx.jpg â†’ http://82.156.213.38/uploads/plants/xxx.jpg
   â†“
æµè§ˆå™¨å‘èµ· GET è¯·æ±‚
```

**å‰ç«¯ä»£ç ï¼š** `/root/Plant-DTP/frontend/src/components/ImageUpload.tsx:173-177`

---

#### 3ï¸âƒ£ äº‘æœåŠ¡å™¨ï¼ˆ82.156.213.38ï¼‰
```
GET /uploads/plants/xxx.jpg
   â†“
Nginxæ¥æ”¶è¯·æ±‚
   â†“
location ^~ /uploads/ {
    proxy_pass http://localhost:12801/uploads/;
    expires 1y;  # ç¼“å­˜1å¹´
}
   â†“
è½¬å‘åˆ° SSHéš§é“ç«¯å£ 12801
```

**Nginxé…ç½®ï¼š** `/etc/nginx/sites-enabled/plant-dtp:22-33`

---

#### 4ï¸âƒ£ åç«¯æœåŠ¡å™¨ï¼ˆè¿œç¨‹ï¼‰
```
FastAPIé™æ€æ–‡ä»¶æœåŠ¡
   â”œâ”€ æŒ‚è½½ç‚¹: app.mount("/uploads", StaticFiles(directory="uploads"))
   â”œâ”€ æ–‡ä»¶è·¯å¾„: /root/Plant-DTP/backend/uploads/plants/xxx.jpg
   â””â”€ è¿”å›: image/jpeg äºŒè¿›åˆ¶æ•°æ®
   â†“
é€šè¿‡ SSHéš§é“è¿”å›å›¾ç‰‡æ•°æ®
```

**åç«¯ä»£ç ï¼š** `/root/Plant-DTP/backend/app/main.py:122`

---

#### 5ï¸âƒ£ è¿”å›å›¾ç‰‡ç»™å®¢æˆ·ç«¯
```
Nginxè¿”å›å›¾ç‰‡
HTTP/1.1 200 OK
Content-Type: image/jpeg
Content-Length: 1828617
Cache-Control: max-age=31536000
   â†“
æµè§ˆå™¨æ˜¾ç¤ºå›¾ç‰‡
```

---

## ğŸ“ æ–‡ä»¶å­˜å‚¨ä½ç½®

### äº‘æœåŠ¡å™¨ï¼ˆ82.156.213.38ï¼‰
```bash
# å‰ç«¯é™æ€æ–‡ä»¶
/var/www/plant-dtp/
â”œâ”€â”€ index.html
â””â”€â”€ assets/
    â”œâ”€â”€ index-C0U20O3o.js
    â””â”€â”€ index-CFH3XUSf.css

# Nginxé…ç½®
/etc/nginx/sites-enabled/plant-dtp
```

### åç«¯æœåŠ¡å™¨ï¼ˆè¿œç¨‹ï¼Œé€šè¿‡SSHéš§é“è®¿é—®ï¼‰
```bash
# åç«¯ä»£ç 
/root/Plant-DTP/backend/
â”œâ”€â”€ app/
â”‚   â”œâ”€â”€ main.py           # FastAPIåº”ç”¨å…¥å£
â”‚   â”œâ”€â”€ api/v1/
â”‚   â”‚   â””â”€â”€ images.py     # å›¾ç‰‡ä¸Šä¼ è·¯ç”±
â”‚   â””â”€â”€ models/
â”‚       â””â”€â”€ plant_image.py # å›¾ç‰‡æ¨¡å‹ï¼ˆå«URLä¿®å¤é€»è¾‘ï¼‰
â”œâ”€â”€ uploads/              # âœ… å›¾ç‰‡å­˜å‚¨åœ¨è¿™é‡Œ
â”‚   â””â”€â”€ plants/
â”‚       â”œâ”€â”€ 53d71a3a-b15e-4305-a31d-77f9526d3a2c.jpg
â”‚       â”œâ”€â”€ cb1c94e9-86d4-44a7-9ffd-68fad158cde9.png
â”‚       â””â”€â”€ 88fe03df-6be9-4771-91e3-210d63f5a43a.jpg
â””â”€â”€ .env                  # ç¯å¢ƒé…ç½®
```

### æ•°æ®åº“ï¼ˆPostgreSQLï¼Œç«¯å£12803ï¼‰
```sql
-- plant_images è¡¨ç»“æ„
CREATE TABLE plant_images (
    id SERIAL PRIMARY KEY,
    plant_id INTEGER REFERENCES plants(id) ON DELETE CASCADE,
    url VARCHAR(500) NOT NULL,           -- âœ… å­˜å‚¨å›¾ç‰‡URL
    caption VARCHAR(200),
    is_primary BOOLEAN DEFAULT FALSE,
    file_size INTEGER,
    width INTEGER,
    height INTEGER,
    taken_at TIMESTAMP WITH TIME ZONE,
    sort_order INTEGER DEFAULT 0,
    created_at TIMESTAMP DEFAULT NOW()
);
```

---

## ğŸ”§ å·²ä¿®å¤çš„é—®é¢˜

### é—®é¢˜1ï¼šæ—§æ•°æ®URLæ ¼å¼é”™è¯¯
**ç°è±¡ï¼š** æ•°æ®åº“ä¸­éƒ¨åˆ†å›¾ç‰‡URLä¸º `http://localhost:12801/uploads/...`
**å½±å“ï¼š** ç§»åŠ¨ç«¯æ— æ³•è®¿é—®ï¼ˆlocalhostæŒ‡å‘æ‰‹æœºæœ¬èº«ï¼‰
**ä¿®å¤ï¼š** âœ… åç«¯ `to_dict()` æ–¹æ³•è‡ªåŠ¨è½¬æ¢
**ä½ç½®ï¼š** `/root/Plant-DTP/backend/app/models/plant_image.py:25-45`

### é—®é¢˜2ï¼šNginxç¼ºå°‘ /uploads/ ä»£ç†
**ç°è±¡ï¼š** 404é”™è¯¯ï¼Œå›¾ç‰‡æ— æ³•è®¿é—®
**ä¿®å¤ï¼š** âœ… æ·»åŠ  `location ^~ /uploads/` é…ç½®
**ä½ç½®ï¼š** `/etc/nginx/sites-enabled/plant-dtp:22-33`

### é—®é¢˜3ï¼šæ–‡ä»¶å¤§å°é™åˆ¶
**ç°è±¡ï¼š** ç§»åŠ¨ç«¯å›¾ç‰‡æ— æ³•ä¸Šä¼ ï¼ˆ>1MBï¼‰
**ä¿®å¤ï¼š** âœ… Nginx `client_max_body_size 20M`
**ä½ç½®ï¼š** `/etc/nginx/sites-enabled/plant-dtp:38`

---

## ğŸ” å…³é”®ä»£ç ä½ç½®

### å‰ç«¯
```bash
/root/Plant-DTP/frontend/src/
â”œâ”€â”€ components/ImageUpload.tsx    # ä¸Šä¼ ç»„ä»¶
â”œâ”€â”€ services/
â”‚   â”œâ”€â”€ api.ts                    # âœ… URLè½¬æ¢é€»è¾‘ï¼ˆå“åº”æ‹¦æˆªå™¨ï¼‰
â”‚   â””â”€â”€ imageService.ts           # å›¾ç‰‡APIè°ƒç”¨
â””â”€â”€ hooks/useImages.ts            # å›¾ç‰‡ç›¸å…³Hook
```

### åç«¯
```bash
/root/Plant-DTP/backend/app/
â”œâ”€â”€ main.py                       # FastAPIå…¥å£ï¼Œé™æ€æ–‡ä»¶æŒ‚è½½
â”œâ”€â”€ api/v1/images.py              # å›¾ç‰‡ä¸Šä¼ è·¯ç”±
â”œâ”€â”€ models/plant_image.py         # âœ… URLè½¬æ¢é€»è¾‘ï¼ˆto_dictæ–¹æ³•ï¼‰
â””â”€â”€ services/plant_image_service.py # å›¾ç‰‡ä¸šåŠ¡é€»è¾‘
```

---

## âš¡ æ€§èƒ½ä¼˜åŒ–å»ºè®®

1. **CDNåŠ é€Ÿï¼š** å°†/uploads/ç›®å½•åŒæ­¥åˆ°CDNï¼Œå‡è½»åç«¯æœåŠ¡å™¨å‹åŠ›
2. **å›¾ç‰‡ç¼©ç•¥å›¾ï¼š** ä¸Šä¼ æ—¶ç”Ÿæˆå¤šå°ºå¯¸ç¼©ç•¥å›¾
3. **æ•°æ®åº“ç´¢å¼•ï¼š** ç¡®ä¿ `plant_id` å­—æ®µæœ‰ç´¢å¼•
4. **ç¼“å­˜ç­–ç•¥ï¼š**
   - Nginxå·²é…ç½®1å¹´ç¼“å­˜ âœ…
   - è€ƒè™‘æ·»åŠ Redisç¼“å­˜çƒ­é—¨å›¾ç‰‡URL

---

## ğŸ“ æ€»ç»“

**æ•°æ®æµæ€»ç»“ï¼š**
- **ä¸Šä¼ ï¼š** å®¢æˆ·ç«¯ â†’ Nginx(80) â†’ SSHéš§é“(12801) â†’ åç«¯ â†’ ä¿å­˜æ–‡ä»¶ â†’ æ•°æ®åº“
- **ä¸‹è½½ï¼š** å®¢æˆ·ç«¯ â†’ Nginx(80) â†’ SSHéš§é“(12801) â†’ åç«¯ â†’ è¿”å›æ–‡ä»¶

**å›¾ç‰‡å­˜å‚¨ï¼š**
- **ç‰©ç†æ–‡ä»¶ï¼š** åç«¯æœåŠ¡å™¨ `/root/Plant-DTP/backend/uploads/plants/`
- **URLè®°å½•ï¼š** PostgreSQLæ•°æ®åº“ `plant_images.url` å­—æ®µ

**å…³é”®ä¿®å¤ï¼š**
1. âœ… åç«¯è‡ªåŠ¨è½¬æ¢localhost URL
2. âœ… Nginxä»£ç†/uploads/è·¯å¾„
3. âœ… æ”¯æŒå¤§æ–‡ä»¶ä¸Šä¼ ï¼ˆ20MBï¼‰
4. âœ… ç§»åŠ¨ç«¯ä¼˜åŒ–UI
